#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const yargs = require("yargs");
const fs = require("fs-extra");
const _ = require("lodash");
const execa = require("execa");
const pino = require("pino");
const axios_1 = require("axios");
const utils_1 = require("../lib/utils");
const L = pino();
const SOURCES = ["managed_policies", "service_names"];
function classFromJson({ jsonObj, key }) {
    let out = "// NOTE: THIS IS MACHINE GENERATED. CHANGES WILL BE OVERWRITTEN!\n\n";
    out += `export class ${_.upperFirst(_.camelCase(key))} {\n`;
    _.each(jsonObj, (v, k) => {
        out += `    public static readonly ${k} = "${v}"\n`;
    });
    out += "}";
    return out;
}
async function fetchConstants({ target }) {
    L.info({ ctx: "fetchConstants/enter", target });
    try {
        switch (target) {
            case "managed_policies":
                let cmd = `python data/all_aws_managed_policies/show_all_aws_managed_policies.py > data/all_aws_managed_policies/all_aws_managed_policies.json`;
                let out = await execa.command(cmd);
                L.info({ ctx: "fetchConstants/exit", out });
                break;
            case "service_names":
                const { data: json } = await axios_1.default.get("https://docs.aws.amazon.com/IAM/latest/UserGuide/toc-contents.json");
                fs.writeJsonSync("data/all_services.json", json);
                const service_titles = json.contents[10].contents[3].contents[6].contents;
                fs.writeJsonSync("data/all_services_title.json", service_titles);
                break;
            default:
                throw `invalid target: ${target}`;
        }
    }
    catch (err) {
        L.error({ ctx: "fetchConstants/error", err });
        throw err;
    }
}
async function updateConstants({ target }) {
    switch (target) {
        case "managed_policies": {
            let data = fs.readJsonSync("./data/all_aws_managed_policies/all_aws_managed_policies.json");
            let results = {};
            let blacklist = ["S_3", "EC_2", "IO_T"];
            L.info({ ctx: "updateConstants/startConverting", target });
            _.keys(data).forEach((key) => {
                let modKey = _.snakeCase(key).toUpperCase();
                blacklist.forEach(ent => {
                    if (modKey.indexOf(ent) >= 0) {
                        modKey = modKey.replace(ent, ent.replace("_", ""));
                    }
                });
                let { Arn } = data[key];
                /**
                 * ARN will look like the following:
                 *    arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
                 * we want to find `aws:policy` and take the name of everything after
                 */
                let idx = Arn.indexOf("aws:policy") + 11;
                results[modKey] = Arn.slice(idx);
            });
            L.info({ ctx: "updateConstants/stopConverting" });
            let payload = classFromJson({
                jsonObj: results,
                key: "MANAGED_POLICIES"
            });
            fs.writeFileSync("./lib/policies.ts", payload);
            L.info({ ctx: "updateConstants/exit" });
            break;
        }
        case "service_names": {
            let data = fs.readJsonSync("./data/all_services_title.json");
            let out = {};
            _.each(data, ent => (out[utils_1.normalizeServiceName(ent.title)] = ent.title));
            let payload = classFromJson({ jsonObj: out, key: "SERVICE_NAMES" });
            fs.writeFileSync("./lib/services.ts", payload);
            break;
        }
        default:
            throw `invalid target: ${target}`;
    }
}
yargs
    .option("stage", {
    alias: "s"
})
    .command(["fetch"], "fetch constants data", {
    targets: {
        description: "constants",
        choices: SOURCES,
        array: true
    }
}, (argv) => {
    L.info({ argv });
    let { targets } = argv;
    try {
        _.reduce(targets, async (prior, target) => {
            await prior;
            return fetchConstants({ target });
        }, Promise.resolve());
    }
    catch (err) {
        L.error({ err });
    }
})
    .command(["update"], "update constants", {
    targets: {
        description: "constants",
        choices: SOURCES,
        array: true
    }
}, async (argv) => {
    let { targets } = argv;
    const resp = _.map(targets, (target) => {
        return updateConstants({ target });
    });
    await Promise.all(resp);
    L.info({ ctx: "update/exit" });
})
    .demandCommand()
    .help()
    .wrap(72).argv;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiY2xpLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUVBLCtCQUErQjtBQUMvQiwrQkFBK0I7QUFDL0IsNEJBQTRCO0FBQzVCLCtCQUErQjtBQUMvQiw2QkFBNkI7QUFDN0IsaUNBQTBCO0FBQzFCLHdDQUFvRDtBQUNwRCxNQUFNLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQztBQUNqQixNQUFNLE9BQU8sR0FBRyxDQUFDLGtCQUFrQixFQUFFLGVBQWUsQ0FBQyxDQUFDO0FBRXRELFNBQVMsYUFBYSxDQUFDLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBaUM7SUFDcEUsSUFBSSxHQUFHLEdBQ0wsc0VBQXNFLENBQUM7SUFDekUsR0FBRyxJQUFJLGdCQUFnQixDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQzVELENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQ3ZCLEdBQUcsSUFBSSw4QkFBOEIsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO0lBQ3RELENBQUMsQ0FBQyxDQUFDO0lBQ0gsR0FBRyxJQUFJLEdBQUcsQ0FBQztJQUNYLE9BQU8sR0FBRyxDQUFDO0FBQ2IsQ0FBQztBQUVELEtBQUssVUFBVSxjQUFjLENBQUMsRUFBRSxNQUFNLEVBQXNCO0lBQzFELENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUNoRCxJQUFJO1FBQ0YsUUFBUSxNQUFNLEVBQUU7WUFDZCxLQUFLLGtCQUFrQjtnQkFDckIsSUFBSSxHQUFHLEdBQUcscUlBQXFJLENBQUM7Z0JBQ2hKLElBQUksR0FBRyxHQUFHLE1BQU0sS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDbkMsQ0FBQyxD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QUMsQ0FBQztRQUNwQyxDQUFDLEVBQ0QsT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUNsQixDQUFDO0tBQ0g7SUFBQyxPQUFPLEdBQUcsRUFBRTtRQUNaLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO0tBQ2xCO0FBQ0gsQ0FBQyxDQUNGO0tBQ0EsT0FBTyxDQUNOLENBQUMsUUFBUSxDQUFDLEVBQ1Ysa0JBQWtCLEVBQ2xCO0lBQ0UsT0FBTyxFQUFFO1FBQ1AsV0FBVyxFQUFFLFdBQVc7UUFDeEIsT0FBTyxFQUFFLE9BQU87UUFDaEIsS0FBSyxFQUFFLElBQUk7S0FDWjtDQUNGLEVBQ0QsS0FBSyxFQUFFLElBQVMsRUFBRSxFQUFFO0lBQ2xCLElBQUksRUFBRSxPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUM7SUFDdkIsTUFBTSxJQUFJLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxNQUFjLEVBQUUsRUFBRTtRQUM3QyxPQUFPLGVBQWUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFDckMsQ0FBQyxDQUFDLENBQUM7SUFDSCxNQUFNLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDeEIsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxhQUFhLEVBQUUsQ0FBQyxDQUFDO0FBQ2pDLENBQUMsQ0FDRjtLQUNBLGFBQWEsRUFBRTtLQUNmLElBQUksRUFBRTtLQUNOLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIjIS91c3IvYmluL2VudiBub2RlXG5cbmltcG9ydCAqIGFzIHlhcmdzIGZyb20gXCJ5YXJnc1wiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzLWV4dHJhXCI7XG5pbXBvcnQgKiBhcyBfIGZyb20gXCJsb2Rhc2hcIjtcbmltcG9ydCAqIGFzIGV4ZWNhIGZyb20gXCJleGVjYVwiO1xuaW1wb3J0ICogYXMgcGlubyBmcm9tIFwicGlub1wiO1xuaW1wb3J0IGF4aW9zIGZyb20gXCJheGlvc1wiO1xuaW1wb3J0IHsgbm9ybWFsaXplU2VydmljZU5hbWUgfSBmcm9tIFwiLi4vbGliL3V0aWxzXCI7XG5jb25zdCBMID0gcGlubygpO1xuY29uc3QgU09VUkNFUyA9IFtcIm1hbmFnZWRfcG9saWNpZXNcIiwgXCJzZXJ2aWNlX25hbWVzXCJdO1xuXG5mdW5jdGlvbiBjbGFzc0Zyb21Kc29uKHsganNvbk9iaiwga2V5IH06IHsganNvbk9iajogYW55OyBrZXk6IHN0cmluZyB9KSB7XG4gIGxldCBvdXQgPVxuICAgIFwiLy8gTk9URTogVEhJUyBJUyBNQUNISU5FIEdFTkVSQVRFRC4gQ0hBTkdFUyBXSUxMIEJFIE9WRVJXUklUVEVOIVxcblxcblwiO1xuICBvdXQgKz0gYGV4cG9ydCBjbGFzcyAke18udXBwZXJGaXJzdChfLmNhbWVsQ2FzZShrZXkpKX0ge1xcbmA7XG4gIF8uZWFjaChqc29uT2JqLCAodiwgaykgPT4ge1xuICAgIG91dCArPSBgICAgIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgJHtrfSA9IFwiJHt2fVwiXFxuYDtcbiAgfSk7XG4gIG91dCArPSBcIn1cIjtcbiAgcmV0dXJuIG91dDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZmV0Y2hDb25zdGFudHMoeyB0YXJnZXQgfTogeyB0YXJnZXQ6IHN0cmluZyB9KSB7XG4gIEwuaW5mbyh7IGN0eDogXCJmZXRjaENvbnN0YW50cy9lbnRlclwiLCB0YXJnZXQgfSk7XG4gIHRyeSB7XG4gICAgc3dpdGNoICh0YXJnZXQpIHtcbiAgICAgIGNhc2UgXCJtYW5hZ2VkX3BvbGljaWVzXCI6XG4gICAgICAgIGxldCBjbWQgPSBgcHl0aG9uIGRhdGEvYWxsX2F3c19tYW5hZ2VkX3BvbGljaWVzL3Nob3dfYWxsX2F3c19tYW5hZ2VkX3BvbGljaWVzLnB5ID4gZGF0YS9hbGxfYXdzX21hbmFnZWRfcG9saWNpZXMvYWxsX2F3c19tYW5hZ2VkX3BvbGljaWVzLmpzb25gO1xuICAgICAgICBsZXQgb3V0ID0gYXdhaXQgZXhlY2EuY29tbWFuZChjbWQpO1xuICAgICAgICBMLmluZm8oeyBjdHg6IFwiZmV0Y2hDb25zdGFudHMvZXhpdFwiLCBvdXQgfSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBcInNlcnZpY2VfbmFtZXNcIjpcbiAgICAgICAgY29uc3QgeyBkYXRhOiBqc29uIH0gPSBhd2FpdCBheGlvcy5nZXQoXG4gICAgICAgICAgXCJodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vSUFNL2xhdGVzdC9Vc2VyR3VpZGUvdG9jLWNvbnRlbnRzLmpzb25cIlxuICAgICAgICApO1xuICAgICAgICBmcy53cml0ZUpzb25TeW5jKFwiZGF0YS9hbGxfc2VydmljZXMuanNvblwiLCBqc29uKTtcbiAgICAgICAgY29uc3Qgc2VydmljZV90aXRsZXMgPVxuICAgICAgICAgIGpzb24uY29udGVudHNbMTBdLmNvbnRlbnRzWzNdLmNvbnRlbnRzWzZdLmNvbnRlbnRzO1xuICAgICAgICBmcy53cml0ZUpzb25TeW5jKFwiZGF0YS9hbGxfc2VydmljZXNfdGl0bGUuanNvblwiLCBzZXJ2aWNlX3RpdGxlcyk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhyb3cgYGludmFsaWQgdGFyZ2V0OiAke3RhcmdldH1gO1xuICAgIH1cbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgTC5lcnJvcih7IGN0eDogXCJmZXRjaENvbnN0YW50cy9lcnJvclwiLCBlcnIgfSk7XG4gICAgdGhyb3cgZXJyO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUNvbnN0YW50cyh7IHRhcmdldCB9OiB7IHRhcmdldDogc3RyaW5nIH0pIHtcbiAgc3dpdGNoICh0YXJnZXQpIHtcbiAgICBjYXNlIFwibWFuYWdlZF9wb2xpY2llc1wiOiB7XG4gICAgICBsZXQgZGF0YSA9IGZzLnJlYWRKc29uU3luYyhcbiAgICAgICAgXCIuL2RhdGEvYWxsX2F3c19tYW5hZ2VkX3BvbGljaWVzL2FsbF9hd3NfbWFuYWdlZF9wb2xpY2llcy5qc29uXCJcbiAgICAgICk7XG4gICAgICBsZXQgcmVzdWx0czogYW55ID0ge307XG4gICAgICBsZXQgYmxhY2tsaXN0ID0gW1wiU18zXCIsIFwiRUNfMlwiLCBcIklPX1RcIl07XG4gICAgICBMLmluZm8oeyBjdHg6IFwidXBkYXRlQ29uc3RhbnRzL3N0YXJ0Q29udmVydGluZ1wiLCB0YXJnZXQgfSk7XG4gICAgICBfLmtleXMoZGF0YSkuZm9yRWFjaCgoa2V5OiBzdHJpbmcpID0+IHtcbiAgICAgICAgbGV0IG1vZEtleSA9IF8uc25ha2VDYXNlKGtleSkudG9VcHBlckNhc2UoKTtcbiAgICAgICAgYmxhY2tsaXN0LmZvckVhY2goZW50ID0+IHtcbiAgICAgICAgICBpZiAobW9kS2V5LmluZGV4T2YoZW50KSA+PSAwKSB7XG4gICAgICAgICAgICBtb2RLZXkgPSBtb2RLZXkucmVwbGFjZShlbnQsIGVudC5yZXBsYWNlKFwiX1wiLCBcIlwiKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgbGV0IHsgQXJuIH0gPSBkYXRhW2tleV07XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBBUk4gd2lsbCBsb29rIGxpa2UgdGhlIGZvbGxvd2luZzpcbiAgICAgICAgICogICAgYXJuOmF3czppYW06OmF3czpwb2xpY3kvc2VydmljZS1yb2xlL0FXU0xhbWJkYUJhc2ljRXhlY3V0aW9uUm9sZVxuICAgICAgICAgKiB3ZSB3YW50IHRvIGZpbmQgYGF3czpwb2xpY3lgIGFuZCB0YWtlIHRoZSBuYW1lIG9mIGV2ZXJ5dGhpbmcgYWZ0ZXJcbiAgICAgICAgICovXG4gICAgICAgIGxldCBpZHggPSBBcm4uaW5kZXhPZihcImF3czpwb2xpY3lcIikgKyAxMTtcbiAgICAgICAgcmVzdWx0c1ttb2RLZXldID0gQXJuLnNsaWNlKGlkeCk7XG4gICAgICB9KTtcbiAgICAgIEwuaW5mbyh7IGN0eDogXCJ1cGRhdGVDb25zdGFudHMvc3RvcENvbnZlcnRpbmdcIiB9KTtcbiAgICAgIGxldCBwYXlsb2FkID0gY2xhc3NGcm9tSnNvbih7XG4gICAgICAgIGpzb25PYmo6IHJlc3VsdHMsXG4gICAgICAgIGtleTogXCJNQU5BR0VEX1BPTElDSUVTXCJcbiAgICAgIH0pO1xuICAgICAgZnMud3JpdGVGaWxlU3luYyhcIi4vbGliL3BvbGljaWVzLnRzXCIsIHBheWxvYWQpO1xuICAgICAgTC5pbmZvKHsgY3R4OiBcInVwZGF0ZUNvbnN0YW50cy9leGl0XCIgfSk7XG4gICAgICBicmVhaztcbiAgICB9XG4gICAgY2FzZSBcInNlcnZpY2VfbmFtZXNcIjoge1xuICAgICAgbGV0IGRhdGEgPSBmcy5yZWFkSnNvblN5bmMoXCIuL2RhdGEvYWxsX3NlcnZpY2VzX3RpdGxlLmpzb25cIik7XG4gICAgICBsZXQgb3V0OiBhbnkgPSB7fTtcbiAgICAgIF8uZWFjaChkYXRhLCBlbnQgPT4gKG91dFtub3JtYWxpemVTZXJ2aWNlTmFtZShlbnQudGl0bGUpXSA9IGVudC50aXRsZSkpO1xuICAgICAgbGV0IHBheWxvYWQgPSBjbGFzc0Zyb21Kc29uKHsganNvbk9iajogb3V0LCBrZXk6IFwiU0VSVklDRV9OQU1FU1wiIH0pO1xuICAgICAgZnMud3JpdGVGaWxlU3luYyhcIi4vbGliL3NlcnZpY2VzLnRzXCIsIHBheWxvYWQpO1xuICAgICAgYnJlYWs7XG4gICAgfVxuICAgIGRlZmF1bHQ6XG4gICAgICB0aHJvdyBgaW52YWxpZCB0YXJnZXQ6ICR7dGFyZ2V0fWA7XG4gIH1cbn1cblxueWFyZ3NcbiAgLm9wdGlvbihcInN0YWdlXCIsIHtcbiAgICBhbGlhczogXCJzXCJcbiAgfSlcbiAgLmNvbW1hbmQoXG4gICAgW1wiZmV0Y2hcIl0sXG4gICAgXCJmZXRjaCBjb25zdGFudHMgZGF0YVwiLFxuICAgIHtcbiAgICAgIHRhcmdldHM6IHtcbiAgICAgICAgZGVzY3JpcHRpb246IFwiY29uc3RhbnRzXCIsXG4gICAgICAgIGNob2ljZXM6IFNPVVJDRVMsXG4gICAgICAgIGFycmF5OiB0cnVlXG4gICAgICB9XG4gICAgfSxcbiAgICAoYXJndjogYW55KSA9PiB7XG4gICAgICBMLmluZm8oeyBhcmd2IH0pO1xuICAgICAgbGV0IHsgdGFyZ2V0cyB9ID0gYXJndjtcbiAgICAgIHRyeSB7XG4gICAgICAgIF8ucmVkdWNlKFxuICAgICAgICAgIHRhcmdldHMsXG4gICAgICAgICAgYXN5bmMgKHByaW9yOiBhbnksIHRhcmdldDogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICBhd2FpdCBwcmlvcjtcbiAgICAgICAgICAgIHJldHVybiBmZXRjaENvbnN0YW50cyh7IHRhcmdldCB9KTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIFByb21pc2UucmVzb2x2ZSgpXG4gICAgICAgICk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgTC5lcnJvcih7IGVyciB9KTtcbiAgICAgIH1cbiAgICB9XG4gIClcbiAgLmNvbW1hbmQoXG4gICAgW1widXBkYXRlXCJdLFxuICAgIFwidXBkYXRlIGNvbnN0YW50c1wiLFxuICAgIHtcbiAgICAgIHRhcmdldHM6IHtcbiAgICAgICAgZGVzY3JpcHRpb246IFwiY29uc3RhbnRzXCIsXG4gICAgICAgIGNob2ljZXM6IFNPVVJDRVMsXG4gICAgICAgIGFycmF5OiB0cnVlXG4gICAgICB9XG4gICAgfSxcbiAgICBhc3luYyAoYXJndjogYW55KSA9PiB7XG4gICAgICBsZXQgeyB0YXJnZXRzIH0gPSBhcmd2O1xuICAgICAgY29uc3QgcmVzcCA9IF8ubWFwKHRhcmdldHMsICh0YXJnZXQ6IHN0cmluZykgPT4ge1xuICAgICAgICByZXR1cm4gdXBkYXRlQ29uc3RhbnRzKHsgdGFyZ2V0IH0pO1xuICAgICAgfSk7XG4gICAgICBhd2FpdCBQcm9taXNlLmFsbChyZXNwKTtcbiAgICAgIEwuaW5mbyh7IGN0eDogXCJ1cGRhdGUvZXhpdFwiIH0pO1xuICAgIH1cbiAgKVxuICAuZGVtYW5kQ29tbWFuZCgpXG4gIC5oZWxwKClcbiAgLndyYXAoNzIpLmFyZ3Y7XG4iXX0=